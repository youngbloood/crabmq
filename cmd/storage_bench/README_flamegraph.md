# 火焰图功能使用说明

## 概述

本功能允许在压测阶段精确控制火焰图的生成，只在正式压测阶段记录性能数据，避免预热阶段的数据干扰。**现在支持跨平台**，使用 `pprof` 库实现。

## 功能特点

- ✅ **精确控制**: 只在压测阶段记录性能数据
- ✅ **跨平台支持**: 支持 Linux、macOS、Windows
- ✅ **自动生成**: 使用 pprof 库自动生成 SVG 火焰图
- ✅ **文件夹输出**: 支持指定输出文件夹，自动生成命名文件
- ✅ **智能命名**: 自动生成 `flamegraph-{分区数}-{消息大小KB}.svg` 格式的文件名
- ✅ **自动创建目录**: 如果输出文件夹不存在，会自动创建

## 使用方法

### 1. 基本用法

```bash
# 启用火焰图功能（使用默认输出文件夹 ./flamegraphs）
cargo run --release -- -p 1000 --enable-flamegraph

# 自定义火焰图输出文件夹
cargo run --release -- -p 1000 --enable-flamegraph --flamegraph-output ./my_flamegraphs
```

### 2. 完整示例

```bash
# 测试1000分区，启用火焰图
cargo run --release -- \
  -p 1000 \
  --enable-flamegraph \
  --flamegraph-output ./flamegraphs \
  --cleanup false
```

### 3. 多分区测试

```bash
# 测试多个分区配置，每个都会生成独立的火焰图
cargo run --release -- \
  -p 1000,2000,5000 \
  --enable-flamegraph \
  --flamegraph-output ./flamegraphs
```

**输出文件示例**:
```
./flamegraphs/
├── flamegraph-1000-10.svg    # 1000分区，10KB消息
├── flamegraph-2000-10.svg    # 2000分区，10KB消息
└── flamegraph-5000-10.svg    # 5000分区，10KB消息
```

## 系统要求

### 所有平台
- **Rust 1.74+**: 支持 pprof 库
- **内存**: 建议 4GB+ 可用内存
- **磁盘空间**: 确保有足够空间存储火焰图文件

### 平台特定要求

#### Linux
- **内核版本**: 2.6.31+ (支持 perf_event_open)
- **权限**: 可能需要调整 perf_event_paranoid 设置
- **功能**: 完整的性能分析功能

#### macOS
- **系统版本**: macOS 10.12+ (Sierra)
- **功能**: 基本的性能分析功能，可能不如Linux完整
- **限制**: 某些高级功能可能不可用

#### Windows
- **系统版本**: Windows 10+ 或 Windows Server 2016+
- **功能**: 基本的性能分析功能
- **限制**: 某些高级功能可能不可用

## 工作原理

1. **预热阶段**: 正常进行预热，不记录性能数据
2. **压测开始**: 启动 pprof 性能分析器，开始记录性能数据
3. **压测进行**: 正常进行压测，同时记录性能数据
4. **压测结束**: 停止性能分析器，生成火焰图
5. **文件生成**: 自动创建输出文件夹并生成命名文件

## 输出文件

### 文件命名规则
```
flamegraph-{分区数}-{消息大小KB}.svg
```

### 示例
- `flamegraph-1000-10.svg`: 1000分区，10KB消息的火焰图
- `flamegraph-2000-5.svg`: 2000分区，5KB消息的火焰图
- `flamegraph-5000-20.svg`: 5000分区，20KB消息的火焰图

## 火焰图解读

生成的火焰图可以帮助你：

- 🔍 **识别热点**: 找到CPU使用率最高的函数
- 📊 **分析调用栈**: 了解函数调用关系
- ⚡ **优化性能**: 针对性地优化瓶颈函数
- 📈 **监控变化**: 对比不同配置下的性能差异

### 火焰图颜色说明
- **红色**: 高CPU使用率区域
- **黄色**: 中等CPU使用率区域
- **绿色**: 低CPU使用率区域
- **蓝色**: 系统调用和库函数

## 注意事项

1. **性能影响**: 火焰图记录会轻微影响测试性能（约 1-5%）
2. **内存使用**: 性能分析器会占用一定内存
3. **磁盘空间**: 确保有足够的磁盘空间存储火焰图文件
4. **文件权限**: 确保有权限创建输出文件夹和文件
5. **平台差异**: 不同平台的性能分析能力可能有所不同

## 故障排除

### 常见问题

1. **权限不足 (Linux)**
   ```bash
   # 临时解决方案
   sudo sh -c 'echo -1 >/proc/sys/kernel/perf_event_paranoid'
   
   # 永久解决方案
   echo 'kernel.perf_event_paranoid = -1' | sudo tee -a /etc/sysctl.conf
   sudo sysctl -p
   ```

2. **磁盘空间不足**
   ```bash
   # 检查磁盘空间
   df -h
   ```

3. **内存不足**
   ```bash
   # 检查可用内存
   free -h  # Linux
   vm_stat  # macOS
   ```

4. **火焰图生成失败**
   - 检查输出文件夹路径是否正确
   - 确认有足够的磁盘空间
   - 查看错误日志信息
   - 在某些平台上，性能分析功能可能受限

### 调试模式

```bash
# 启用详细日志
RUST_LOG=debug cargo run --release -- -p 1000 --enable-flamegraph
```

## 示例输出

```
[验证] 创建火焰图输出目录: ./flamegraphs
生成的测试配置数量: 1
测试配置:
  1. 分区数: 1000, 消息大小: 10KB

[预热] 开始预热 1000 个分区...
[预热] 完成
[火焰图] 开始记录性能数据...
[火焰图] 性能分析器已启动
进入压测阶段...

---------------------------- 开始动态速率测试 (多分区) ----------------------------
|速率(MB/s)|测试时长(s)|发送量(MB)|落盘量(MB)|墙钟耗时(ms)|墙钟吞吐量(MB/s)|分区数|
|     300.0|       15.0|    4502.0|    4457.9|     13891.2|           320.9|  1000|
...

[火焰图] 停止记录性能数据...
[火焰图] 火焰图已生成: ./flamegraphs/flamegraph-1000-10.svg
```

## 性能优化建议

基于火焰图分析结果，你可以：

1. **识别热点函数**: 找到CPU使用率最高的函数进行优化
2. **减少系统调用**: 优化频繁的系统调用
3. **内存分配优化**: 减少不必要的内存分配
4. **算法优化**: 改进低效的算法实现
5. **并发优化**: 提高并发处理效率

## 与其他工具对比

| 特性 | pprof (当前) | perf + flamegraph.pl | 优势 |
|------|-------------|---------------------|------|
| 跨平台支持 | ✅ 全平台 | ❌ 仅Linux | 更好的兼容性 |
| 安装复杂度 | ✅ 零配置 | ❌ 需要安装perf | 更简单的部署 |
| 性能影响 | ✅ 低影响 | ✅ 低影响 | 相当 |
| 功能完整性 | ⚠️ 平台相关 | ✅ 完整 | Linux上perf更完整 |
| 维护成本 | ✅ 低 | ❌ 高 | 更低的维护成本 |

## 平台兼容性说明

### Linux (推荐)
- **最佳支持**: 完整的性能分析功能
- **推荐使用**: 生产环境性能分析的首选平台

### macOS
- **基本支持**: 可以生成火焰图，但功能可能受限
- **适用场景**: 开发和测试环境

### Windows
- **基本支持**: 可以生成火焰图，但功能可能受限
- **适用场景**: 开发和测试环境 