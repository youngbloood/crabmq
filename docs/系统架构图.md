# CrabMQ 系统架构图（基于《副本一致性实施计划》实现后）

下图以 PlantUML 格式描述了在完成实施计划后系统的核心组件与交互：

- Coordinator Cluster（高可用，建议使用 Raft）：负责元数据、leader 选举、`cgo`（consumer offsets）持久化与 epoch 管理。
- Brokers：负责数据存储（LEO/HW）、副本间数据同步、向 Leader 提供读写服务，以及向 Coordinator 汇报心跳与分区状态。
- Clients（Producer / Consumer）：
  - 写入走 Leader Broker；
  - Offset 提交到 Coordinator（权威），同时向 Broker 发送滑动窗口释放通知。
- Replication Transport：Broker 之间使用复用连接（stream_id 多路复用），减少连接数并提高效率。

文件：
- PlantUML 源文件：[docs/系统架构图.puml](docs/系统架构图.puml)

如何查看：
1. 使用 PlantUML 渲染：

```bash
# 若已安装 plantuml
plantuml docs/系统架构图.puml
```

2. 或使用 VS Code PlantUML 插件直接预览 `docs/系统架构图.puml`。

简短说明：
- 客户端通过 Service Discovery 获取 Coordinator 与 Broker 地址（或直接配置），写入请求路由到 Partition 的 Leader Broker；
- Broker 定期向 Coordinator 发心跳，Coordinator 根据心跳更新元数据并在需要时下发角色变更；
- 消费者提交 offset 到 Coordinator（持久化），并同时通知 Broker 释放滑动窗口；Broker 本身仅维护内存滑动窗口；
- Coordinator 为系统元数据的权威，要求 HA 与持久化来避免单点故障。

如需我把该 PlantUML 转成 PNG 并提交到仓库（需在本地或 CI 环境运行 PlantUML），我可以生成渲染命令和 CI 示例。 
