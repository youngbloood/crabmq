````markdown
# 副本一致性实施计划 — 审阅与改进建议

概述：对现有《副本一致性实施计划》的审阅结论与落地改进建议。按优先级给出必须补完的项、建议的实现方向与验收要点，便于工程和运维在上线前跟进。

## 一、关键风险（必须在上线前解决）
- **Offset 存储不一致**：文档建议将 Consumer Group Offset 存于 `PartitionClusterInfo.cgo`（Coordinator），但当前实现仍把 commit 写入 Broker。风险：Broker 宕机导致 offset 丢失或不一致。建议：在 Coordinator 实现 authoritative offset 存储并持久化，短期实现双写（Client 同时写 Coordinator 与通知 Broker 更新滑动窗口），并提供回滚策略。
- **Coordinator 单点/HA 未说明**：Coordinator 被定义为权威但未给 HA、持久化方案（如是否使用 Raft 或 WAL）。建议：采用 Raft 或使用外部 consensus（etcd/consul），并对 epoch/cgo 做 WAL+定期 snapshot。验收：Coordinator 重启后 epoch/cgo 恢复且不产生双主。
- **选举与并发控制模糊**：选举流程缺少多数规则、并发竞选与冲突解决细节。建议：明确投票规则（多数 quorum）、选举超时、leader lease 与防止旧 leader 写入的检测逻辑。

## 二、优先改进（高优先级）
- 明确一致性语义（先在文档开头写明：目标为 at-least-once / 强一致 / 最终一致等），以指导 HW/LEO、ACK 语义和客户端行为。
- 定义 Offset 提交协议（RPC 接口、幂等/序列化语义、批量提交、错误重试策略）。示例：`CommitOffsetReq{group,topic,partition,offset,client_id}`；响应需保证持久化确认。
- 增加持久化契约：明确哪些字段需要 WAL、何时 flush、事务边界（例如在 elect+persist epoch 与更新 PartitionInfo 时要原子化）。

## 三、中级改进（中优先级）
- 定义 ISR（In-Sync Replica）进入/退出条件、滞后阈值、最小副本数与 HW 计算策略，并列出默认阈值（可调）。
- 补充关键时间参数默认值与调优建议：heartbeat_interval（默认1s）、heartbeat_timeout（默认3s）、election_timeout（默认5s~10s）、sync_interval、fetch_backoff 等。
- 补充迁移/兼容策略：从 Broker 存储迁移到 Coordinator 的步骤、如何处理双写不一致、回滚方案与兼容的客户端版本策略。

## 四、低优先级与运维（低优先级）
- 增强监控与告警：列出必须监控的 metric（heartbeat_latency, partition_sync_lag, hw_lag, leader_election_rate, commit_failure_rate），并给出示例告警阈值和响应流程。
- 提供运维 Runbook：如何强制选举、如何逐个恢复挂掉的 Broker、如何补同步滞后副本、如何回放或修复 cgo 异常。
- 增加日志截断、快照与磁盘饱和策略说明，避免磁盘耗尽导致服务不稳定。

## 五、测试与验证清单（必须可自动化）
- 单元/集成：epoch 演进、选举并发、HW 计算、LEO 更新原子性、双写/迁移一致性验证。
- 故障注入：随机停止 Broker、网络分区、延迟和丢包；断言：无数据丢失（按一致性目标）、选举完成时间、无双主写入。
- 性能：吞吐（TPS）、同步延迟（ms）、选举恢复时间（s）；给出基准场景与可重复脚本。

## 六、示例迁移步骤（把 Offset 从 Broker 迁移到 Coordinator）
1. 在 Coordinator 实现并暴露 `CommitOffset` 接口与持久化逻辑。
2. 客户端发布新版（支持双写）：Commit 同步写入 Coordinator，同时发送现有 Broker Commit 用于滑动窗口更新。
3. 监控双写成功率，运行一段稳定期（N 天）后，逐步在 Broker 端禁用持久化 commit，只保留滑动窗口通知逻辑。
4. 回滚路径：若 Coordinator 出问题，客户端回退到仅向 Broker 提交并回滚迁移。

## 七、简短优先级行动项（可以作为上线前清单）
- 必做：实现 Coordinator offset 存储并持久化；明确 Coordinator HA 方案
- 必做：定义并实现 Commit RPC 与重试/幂等策略
- 必做：补充选举算法的多数/lease/超时细节并实现相关测试
- 优先：增加运行时默认超时参数与监控告警规则
- 可选：连接多路复用的 QUIC 评估（长期）

---

作者注：该文档为对原实施计划的审阅摘要与可执行改进建议，已按上线风险优先级排序，便于工程快速拆解为开发任务与测试用例。如需我把每项拆成更细的 Jira 风险/任务清单或补充 RPC 接口样例代码，我可以继续生成。
````
